<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form SVR</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="js/api.js"></script>
  <script type="module" src="js/form_svr.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #eff6ff, #dbeafe);
      font-family: 'Prompt', sans-serif;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      background: #ffffff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* SweetAlert2 styling matching Tested.html */
    .swal2-border {
      border-radius: 1rem !important;
      padding: 1.2rem !important;
      font-family: 'Prompt', sans-serif;
    }

    .swal2-title-custom {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1e3a8a !important;
    }

    .tab {
      display: none
    }

    .tab.active {
      display: block
    }

    .step-indicator span {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin: 0 5px;
      background: #cbd5e1;
      border-radius: 50%;
    }

    .step-indicator .active {
      background: #2563eb;
    }

    .step-title {
      font-size: 1rem;
      font-weight: 600;
      color: #26a69a;
      margin-bottom: 10px;
    }

    canvas {
      border: 1px solid #ccc;
      background: white;
      margin: auto;
      display: block;
    }

    .center-button {
      text-align: center;
      margin-top: 10px
    }

    #signature-pad {
      width: 100%;
      /* ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á container */
      max-width: 100%;
      /* ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö */
      height: 150px;
      /* ‡∏™‡∏π‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
      border: 1px solid #ccc;
      background: white;
      display: block;
      margin: auto;
    }

    .person-row {
      margin-bottom: 16px
    }

    .person-row>.id-input-group {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .remove-btn {
      background: none;
      border: none;
      color: #e53935;
      font-size: 1.2rem;
      cursor: pointer
    }

    .worker-details {
      margin-top: 8px;
    }

    .worker-details .input-field {
      width: 100%;
      margin-bottom: 8px
    }

    @media(min-width:600px) {
      .worker-details .input-field {
        /* display: inline-block;
        width: calc(25% - 8px); */
        margin-right: 8px
      }
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏ô Chrome/Safari */
    input[type="date"]::-webkit-calendar-picker-indicator {
      display: none;
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏ô Firefox */
    input[type="date"]::-moz-calendar-picker-indicator {
      display: none;
    }

    .btn.teal {
      background-color: #2563eb !important;
    }

    .btn.teal:hover {
      background-color: #1d4ed8 !important;
    }

    .btn.red {
      background-color: #dc2626 !important;
    }

    .btn.red:hover {
      background-color: #b91c1c !important;
    }

    .btn.grey {
      background-color: #6b7280 !important;
    }

    .btn.grey:hover {
      background-color: #4b5563 !important;
    }

    .form-header-section {
      text-align: center;
      margin: -1rem 0 1.5rem;
    }

    .form-logo {
      width: 100px;
      height: auto;
      margin-bottom: 0rem;
      opacity: 0;
      animation: logoFade 0.8s forwards ease;
    }

    @keyframes logoFade {
      to {
        opacity: 1;
      }
    }

    .form-header {
      font-family: 'Prompt', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      color: #1d4ed8;
      /* Tailwind Blue-800 */
      margin: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- <h5 class="center-align">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á Server Room</h5> -->
    <div class="form-header-section">
      <img
        src="https://datagov.mot.go.th/uploads/group/2021-06-17-091516.344386imgd1daf68b032d6c67143d45f8686e2aea.png"
        alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó"
        width="100"
        height="100"
        loading="lazy"
        decoding="async"
        class="form-logo"
      />
      <h3 class="form-header">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á Server Room</h3>
    </div>
    <form id="regForm">
      <!-- Step 1 -->
      <div class="tab">
        <div class="step-title">Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠</div>
        <div class="input-field">
          <input id="input1" name="input1" type="text" maxlength="17" required oninput="formatIDCard(this)">
          <label  class="active" for="input1">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input2" name="input2" type="text" required>
          <label  class="active" for="input2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input3" name="input3" type="text" required>
          <label  class="active" for="input3">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input4" name="input4" type="tel" required>
          <label  class="active" for="input4">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input5" name="input5" type="email" required>
          <label  class="active" for="input5">Email<span style="color:#dc3545">*</span></label>
        </div>
      </div>
      <!-- Step 2 -->
      <div class="tab">
        <div class="step-title">Step 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="input-field">
          <input id="input6" name="input6" type="text" required>
          <label  class="active" for="input6">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏£‡∏∞‡∏ö‡∏ö<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input7" name="input7" type="text" required>
          <label  class="active" for="input7">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input8" name="input8" type="date" class="datepicker" required>
          <label  class="active" class="active" for="input8">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="input9" name="input9" type="date" class="datepicker" required>
          <label  class="active" class="active" for="input9">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="Time_in" name="Time_in" type="time" required>
          <label  class="active" class="active" for="Time_in">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô<span style="color:#dc3545">*</span></label>
        </div>
        <div class="input-field">
          <input id="Time_out" name="Time_out" type="time" required>
          <label  class="active" class="active" for="Time_out">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î<span style="color:#dc3545">*</span></label>
        </div>
        <label><input type="checkbox" id="input10_1" name="input10_1"><span>‡∏´‡πâ‡∏≠‡∏á MIS</span></label><br>
        <label><input type="checkbox" id="input10_2" name="input10_2"><span>‡∏´‡πâ‡∏≠‡∏á E-Ticket</span></label>
      </div>
      <!-- Step 3 -->
      <div class="tab">
        <div class="step-title">Step 3: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
        <div id="personnel-list"></div>
        <!-- ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ï‡πâ #personnel-list -->
        <div id="checking" style="display:none;color:Blue;margin-top:4px">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div style="margin-top: 10px">
          <button type="button" class="btn teal" onclick="addPersonnelField()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
        </div>
        <label style="margin-top: 10px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 20 ‡∏Ñ‡∏ô / ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
        <!-- <label style="margin-top: 10px;">‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 20 ‡∏Ñ‡∏ô:</label>
        <div class="file-field input-field">
          <div class="btn"><span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV</span><input type="file" id="csvFile" accept=".csv"></div>
          <div class="file-path-wrapper"><input class="file-path validate" type="text"></div>
        </div> -->
      </div>
      <!-- Step 4 -->
      <div class="tab">
        <div class="step-title">Step 4: ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
        <div class="file-field input-field">
          <div class="btn"><span>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå 1</span><input type="file" name="file1" id="file1"></div>
          <div class="file-path-wrapper"><input class="file-path validate" type="text"></div>
        </div>
        <div class="file-field input-field">
          <div class="btn"><span>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå 2</span><input type="file" name="file2" id="file2"></div>
          <div class="file-path-wrapper"><input class="file-path validate" type="text"></div>
        </div>
        <div class="input-field">
          <textarea id="input12" name="input12" class="materialize-textarea"></textarea>
          <label for="input12">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</label>
        </div>
      </div>
      <!-- Step 5 -->
      <!-- Step 5 -->
      <!-- Step 5 -->
      <div class="tab">
        <div class="step-title">Step 5: ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>

        <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
        <div style="margin-bottom: 20px;">
          <label>
          <input type="checkbox" id="agreeTerms">
          <span>‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö <a href="#" onclick="showTermsPopup()">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</a></span>
        </label>
        </div>

        <label>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏ß‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™):</label><br>
        <canvas id="signature-pad" height="150"></canvas>
        <div class="center-button">
          <button type="button" class="btn red" onclick="clearSignature()">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
        </div>
      </div>

      <!-- Navigation -->
      <div class="center-align" style="margin-top:20px">
        <button type="button" id="prevBtn" class="btn grey" onclick="nextPrev(-1)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button type="button" id="nextBtn" class="btn teal" onclick="nextPrev(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
      <div class="step-indicator center-align" style="margin-top:20px"></div>
    </form>
  </div>

  <!-- ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å Code.gs -->
  <script>
    const SCRIPT_URL = "<?= SCRIPT_URL ?>";
  </script>
  <!-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô Materialize
    document.addEventListener('DOMContentLoaded', function(){
      M.Datepicker.init(document.querySelectorAll('.datepicker'), {
        format:'yyyy-mm-dd',
        autoClose:true
      });
    });

    let currentTab = 0;
    showTab(currentTab);

    function showTab(n){
      const tabs = document.getElementsByClassName('tab');
      Array.from(tabs).forEach(t=>t.classList.remove('active'));
      tabs[n].classList.add('active');
      document.getElementById('prevBtn').style.display = (n===0?'none':'inline');
      document.getElementById('nextBtn').innerText = (n===tabs.length-1?'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á':'‡∏ñ‡∏±‡∏î‡πÑ‡∏õ');
      if(n===4) resizeCanvas();
      const ind = document.querySelector('.step-indicator');
      ind.innerHTML = '';
      for(let i=0;i<tabs.length;i++){
        const dot = document.createElement('span');
        if(i===n) dot.classList.add('active');
        ind.appendChild(dot);
      }
    }

    function validateForm() {
      const fieldNames = {
        input1: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",
        input2: "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
        input3: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó",
        input4: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
        input5: "Email",
        input6: "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏£‡∏∞‡∏ö‡∏ö",
        input7: "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå",
        input8: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
        input9: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î",
        Time_in: "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
        Time_out: "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î"
      };

      const inputs = document.querySelectorAll('.tab.active input[required], .tab.active textarea[required]');
      for (const inp of inputs) {
        const val = inp.value.trim();
        let label = fieldNames[inp.id] || '‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á';

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô input ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô
        if (label.includes('‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')) {
          const row = inp.closest('.person-row');
          if (row) {
            const rows = Array.from(document.querySelectorAll('.person-row'));
            const index = rows.indexOf(row) + 1;
            label += ` #${index}`;
          }
        }

        if (!val) {
          Swal.fire({
            icon: 'warning',
            title: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "${label}"`,
            html: `<span style="color:red">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å ${label}</span><br>‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }

        if (inp.id === 'input1') {
          const cid = inp.dataset.raw || '';
          if (cid.length !== 13) {
            Swal.fire({
              icon: 'warning',
              title: '‚ùå ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
              html: `<span style="color:red">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å</span>`,
              width: 'clamp(300px, 90%, 420px)',
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            });
            return false;
          }
        }

        if (inp.id === 'input5') {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(val)) {
            Swal.fire({
              icon: 'warning',
              title: '‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Email ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
              html: `<span style="color:red">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô user@example.com</span>`,
              width: 'clamp(300px, 90%, 420px)',
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            });
            return false;
          }
        }
      }

      // Step 2
      if (currentTab === 1) {
        const timeIn = document.getElementById('Time_in').value;
        const timeOut = document.getElementById('Time_out').value;
        if (timeIn && timeOut && timeIn >= timeOut) {
          Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }

        const dateStart = document.getElementById('input8').value;
        const dateEnd = document.getElementById('input9').value;
        if (dateStart && dateEnd && dateEnd < dateStart) {
          Swal.fire({
            icon: 'warning',
            title: '‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            html: `<span style="color:red">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }
      }

      // Step 3
      if (currentTab === 2) {
        const people = document.querySelectorAll('#personnel-list .person-row');
        if (people.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô',
            html: `<span style="color:red">‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span><br>‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }

        for (let i = 0; i < people.length; i++) {
          const row = people[i];
          const inp = row.querySelector('input[type=text]');
          const cid = inp?.dataset.raw || '';
          const name = inp?.dataset.name || '';
          const num = i + 1;

          if (cid.length !== 13) {
            Swal.fire({
              icon: 'warning',
              title: `‚ùå ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö`,
              html: `<span style="color:red">‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà #${num}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å</span>`,
              width: 'clamp(300px, 90%, 420px)',
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            });
            return false;
          }

          if (!name) {
            Swal.fire({
              icon: 'error',
              title: `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô`,
              html: `<span style="color:red">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ<br>‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö #${num} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</span><br>‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à<br><a href="${SCRIPT_URL}?action=tested" target="_blank">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a>`,
              width: 'clamp(300px, 90%, 420px)',
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            });
            return false;
          }
        }
      }

      // Step 4
      if (currentTab === 3) {
        const file1 = document.getElementById('file1').files[0];
        if (!file1) {
          Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏≥',
            html: `<span style="color:red">‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå</span>`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }
      }

      // Step 5
      if (currentTab === 4) {
        const chk = document.getElementById('agreeTerms');
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');

        if (!chk.checked) {
          Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç',
            html: `<span style="color:red">‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</span>`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á ‡πÜ
        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let isSigned = false;
        for (let i = 0; i < pixels.length; i += 4) {
          if (pixels[i + 3] !== 0 && (pixels[i] !== 255 || pixels[i + 1] !== 255 || pixels[i + 2] !== 255)) {
            isSigned = true;
            break;
          }
        }

        if (!isSigned) {
          Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á',
            html: `<span style="color:red">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>`,
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          return false;
        }
      }

      return true; // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    }







    function nextPrev(n){
      const tabs = document.getElementsByClassName('tab');
      if(n===1 && !validateForm()) return;
      tabs[currentTab].classList.remove('active');
      currentTab += n;
      if(currentTab>=tabs.length){
        submitForm();
        return;
      }
      showTab(currentTab);
    }



  async function submitForm() {
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('prevBtn').style.display = 'none';

    Swal.fire({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠...',
      html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => {
        Swal.showLoading();
      },
      width: 'clamp(300px, 90%, 420px)',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      confirmButtonColor: '#2563eb',
      customClass: {
        title: 'swal2-title-custom',
        popup: 'swal2-border'
      }
    });

    const form = document.getElementById('regForm');
    const raw = Object.fromEntries(new FormData(form).entries());

    delete raw.file1;
    delete raw.file2;

    const canvas = document.getElementById('signature-pad');
    raw.signature = canvas.toDataURL('image/png').split(',')[1];

    async function toBase64(f) {
      return new Promise((resolve, reject) => {
        const rd = new FileReader();
        rd.onload = () => resolve(rd.result.split(',')[1]);
        rd.onerror = e => reject(e);
        rd.readAsDataURL(f);
      });
    }

    (async () => {
      const f1 = document.getElementById('file1').files[0];
      if (f1) raw.file1 = { name: f1.name, type: f1.type, content: await toBase64(f1) };
      const f2 = document.getElementById('file2').files[0];
      if (f2) raw.file2 = { name: f2.name, type: f2.type, content: await toBase64(f2) };

      raw.personnelList = [];
      document.querySelectorAll('#personnel-list .person-row').forEach(row => {
        const inp = row.querySelector('input[type=text]');
        const cid = inp.dataset.raw;
        const name = inp.dataset.name;
        const company = inp.dataset.company;
        const phone = inp.dataset.phone;
        const email = inp.dataset.email;
        if (cid?.length === 13 && name) {
          raw.personnelList.push({ cid, name, company, phone, email });
        }
      });

      google.script.run
        .withSuccessHandler(res => {
          Swal.close();
          if (res.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: '‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              // html: `<span style="font-weight:bold;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠ : ${res.noSVR}</span><br><span style="color:green">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`,
              html: `<span style="color:green">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`,
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            }).then(() => {
              document.getElementById('nextBtn').style.display = 'none';
              document.getElementById('prevBtn').style.display = 'none';

              const formContainer = document.querySelector('.container');
              formContainer.innerHTML = `
                <p style="text-align:center; font-size:1.4rem; font-weight:bold; color:#2563eb; margin-bottom: 1rem;">
                  ‚úÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                </p>

                <div style="
                  max-width: 620px;
                  margin: 0 auto;
                  background: #f9fafb;
                  padding: 0rem 1rem;
                  border-radius: 16px;
                  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
                  font-size: 1rem;
                  line-height: 1.7;
                  color: #1f2937;
                ">
                  <p><strong>üë§ ‡∏ä‡∏∑‡πà‡∏≠ :</strong> ${res.requester}</p>
                  <p><strong>üè¢ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó :</strong> ${res.company}</p>
                  <p><strong>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ :</strong> ${res.phone}</p>
                  <p><strong>üìß Email :</strong> ${res.email}</p>
                  <p><strong>üóÇÔ∏è ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏£‡∏∞‡∏ö‡∏ö :</strong> ${res.project}</p>
                  <p><strong>üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå :</strong> ${res.purpose}</p>
                  <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô :</strong> ${res.dateStart}</p>
                  <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î :</strong> ${res.dateEnd}</p>
                  <p><strong>üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô :</strong> ${res.timeIn}</p>
                  <p><strong>üïî ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î :</strong> ${res.timeOut}</p>
                </div>

                <p style="text-align:center; font-size:1rem; color:#ff0000; margin-top:1rem;">
                  üì© ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ
                </p>
              `;
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: res.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏',
              width: 'clamp(300px, 90%, 420px)',
              confirmButtonColor: '#2563eb',
              customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
            });
            document.getElementById('nextBtn').style.display = 'inline';
          }
        })
        .withFailureHandler(err => {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: err.message || String(err),
            width: 'clamp(300px, 90%, 420px)',
            confirmButtonColor: '#2563eb',
            customClass: { title: 'swal2-title-custom', popup: 'swal2-border' }
          });
          document.getElementById('nextBtn').style.display = 'inline';
        })
        .submitRequest(raw);
    })();
  }


    function formatIDCard(el){
      let v=el.value.replace(/\D/g,'').slice(0,13);
      el.dataset.raw=v;
      el.value=v.replace(/(\d{1})(\d{4})(\d{5})(\d{2})(\d{1})/,'$1-$2-$3-$4-$5');
    }

   
    function addPersonnelField() {
      const container = document.getElementById('personnel-list');
      const row = document.createElement('div');
      row.className = 'person-row';

      const group = document.createElement('div');
      group.className = 'id-input-group';

      const input = document.createElement('input');
      input.type = 'text';
      input.required = true;
      input.maxLength = 17;
      input.dataset.raw = '';
      input.placeholder = ''; // ‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô updatePersonnelLabels()
      input.oninput = function () {
      formatIDCard(this);
      const cid = this.dataset.raw || '';
      const row = this.closest('.person-row');
      const det = row.querySelector('.worker-details');

      if (cid.length === 13) {
        document.getElementById('checking').style.display = 'block';
        clearTimeout(this._to);
        this._to = setTimeout(() => checkWorkerFromCID(this), 500);
      } else {
        // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
        this.dataset.name = '';
        this.dataset.company = '';
        this.dataset.phone = '';
        this.dataset.email = '';
        det.innerHTML = '';
      }
    };

      const label = document.createElement('label');
      label.className = 'active person-label'; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç
      label.textContent = ''; // ‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô updatePersonnelLabels()

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úï';
      removeBtn.onclick = () => {
        container.removeChild(row);
        updatePersonnelLabels();
      };

      group.append(input, label, removeBtn);
      row.append(group);

      const details = document.createElement('div');
      details.className = 'worker-details';
      row.append(details);

      container.append(row);
      updatePersonnelLabels();
    }

    function updatePersonnelLabels() {
      const rows = document.querySelectorAll('#personnel-list .person-row');
      rows.forEach((row, index) => {
        const label = row.querySelector('.person-label');
        const input = row.querySelector('input[type="text"]');
        label.textContent = `#${index + 1}`;
        input.placeholder = `‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô #${index + 1}`;
      });
    }


    // ‡∏õ‡∏£‡∏±‡∏ö checkWorkerFromCID() ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô label ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà input ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // function checkWorkerFromCID(el){
    //   const cid=el.dataset.raw; if(cid.length!==13) return;
    //   google.script.run.withSuccessHandler(res=>{
    //     document.getElementById('checking').style.display='none';
    //     const row=el.closest('.person-row'), det=row.querySelector('.worker-details');
    //     det.innerHTML='';
    //     if(res?.fullName){
    //       [['fullName','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'],['company','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'],['phone','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'],['email','Email']]
    //       .forEach(([k,label])=>{
    //         const w=document.createElement('div'); w.className='input-field';
    //         const i=document.createElement('input'); i.type='text'; i.readOnly=true; i.value=res[k];
    //         const l=document.createElement('label'); l.className='active'; l.textContent=label;
    //         w.append(i,l); det.append(w);
    //       });
    //       el.dataset.name=res.fullName;
    //       el.dataset.company=res.company;
    //       el.dataset.phone=res.phone;
    //       el.dataset.email=res.email;
    //     } else {
    //       const lbl = document.createElement('div');
    //       lbl.style.color = 'red';
    //       lbl.style.fontWeight = 'bold';
    //       lbl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
    //       det.append(lbl);
    //       el.dataset.name = '';
    //     }
    //   }).findWorkerFromCID(cid);
    // }

    function checkWorkerFromCID(el) {
      const cid = el.dataset.raw;
      if (cid.length !== 13) return;

      google.script.run.withSuccessHandler(res => {
        document.getElementById('checking').style.display = 'none';
        const row = el.closest('.person-row');
        const det = row.querySelector('.worker-details');
        det.innerHTML = '';

        if (res?.fullName) {
          [['fullName', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], ['company', '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'], ['phone', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'], ['email', 'Email']]
            .forEach(([key, labelText]) => {
              if (!res[key]) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Å‡πá‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á

              const div = document.createElement('div');
              div.className = 'input-field';

              const input = document.createElement('input');
              input.type = 'text';
              input.readOnly = true;
              input.value = res[key];

              const label = document.createElement('label');
              label.className = 'active';
              label.textContent = labelText;

              div.append(input, label);
              det.append(div);
            });

          el.dataset.name = res.fullName;
          el.dataset.company = res.company;
          el.dataset.phone = res.phone;
          el.dataset.email = res.email;
        } else {
          const div = document.createElement('div');
          div.className = 'input-field';

          // const label = document.createElement('label');
          // label.className = 'active';
          // label.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';

          const status = document.createElement('span');
          status.style.color = 'red';
          status.style.fontWeight = 'bold';
          status.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';

          div.append(status);
          det.append(div);
        }
      }).findWorkerFromCID(cid);
    }

    function clearSignature(){
      const c=document.getElementById('signature-pad');
      c.getContext('2d').clearRect(0,0,c.width,c.height);
    }
    function resizeCanvas(){
      const c=document.getElementById('signature-pad');
      c.width=c.clientWidth; c.height=150;
    }
    window.addEventListener("load", () => {
      const canvas = document.getElementById("signature-pad");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        // ‡∏õ‡∏£‡∏±‡∏ö canvas.width/height ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà CSS ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        canvas.width  = canvas.clientWidth;
        canvas.height = 150;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏î‡∏ö‡∏ô canvas
      canvas.style.touchAction = 'none';

      let drawing = false, lastX = 0, lastY = 0;
      function start(e) {
        drawing = true;
        const pt = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        lastX = pt.clientX - rect.left;
        lastY = pt.clientY - rect.top;
        e.preventDefault();
      }
      function move(e) {
        if (!drawing) return;
        const pt = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        const x = pt.clientX - rect.left;
        const y = pt.clientY - rect.top;
        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        lastX = x; lastY = y;
        e.preventDefault();
      }

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("touchstart", start);
      canvas.addEventListener("mousemove", move);
      canvas.addEventListener("touchmove", move);
      canvas.addEventListener("mouseup",   () => drawing = false);
      canvas.addEventListener("touchend", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);
    });

  </script>

  <script>
    function showTermsPopup() {
      Swal.fire({
        icon: 'info',
        title: 'üîê ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á',
        html: `
          <div style="text-align: left; font-size: 1rem; color: #374151; line-height: 1.6;">
            ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°<br>
            ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö :<br><br>

            ‚úÖ <strong>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à</strong> ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°<br>
            <a href="https://drive.google.com/file/d/1Z5cbRfR9T9CL9t024MkmxzyLrROAvn9y/view" target="_blank"
              style="color: #2563eb; font-weight: bold; text-decoration: none;">
              üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</a><br><br>

            üõë <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏±‡πâ‡∏ô</strong> ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á Server Room<br>
            üö´ <span style="color:red;"><strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡∏≠‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</strong> ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span><br><br>

            ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ <strong>‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</strong>
          </div>
        `,
        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
        width: 'clamp(320px, 95%, 500px)',
        confirmButtonColor: '#2563eb',
        customClass: {
          title: 'swal2-title-custom',
          popup: 'swal2-border'
        }
      });
    }
  </script>


</body>

</html>
